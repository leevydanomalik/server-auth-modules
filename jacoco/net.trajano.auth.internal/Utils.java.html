<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Utils.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Server Auth Modules</a> &gt; <a href="index.source.html" class="el_package">net.trajano.auth.internal</a> &gt; <span class="el_source">Utils.java</span></div><h1>Utils.java</h1><pre class="source lang-java linenums">package net.trajano.auth.internal;

import java.io.ByteArrayInputStream;
import java.security.GeneralSecurityException;
import java.security.PublicKey;
import java.security.Signature;

import javax.json.Json;
import javax.json.JsonObject;
import javax.servlet.http.HttpServletRequest;

/**
 * Utility methods. Normally these would be in a separate JAR file like
 * commons-lang, but to prevent complications during installation such as
 * requiring to install additional JAR files, this class was created.
 *
 * @author Archimedes Trajano
 *
 */
public final class Utils {
    /**
     * Gets the JWS Payload from a &lt;a href=
     * &quot;http://tools.ietf.org/html/draft-ietf-jose-json-web-signature-30#section-3.1&quot;
     * &gt;JWS Compact Serialization&lt;/a&gt;. The validation follows the rules in &lt;a
     * href=
     * &quot;http://tools.ietf.org/html/draft-ietf-jose-json-web-signature-30#section-5.2&quot;
     * &gt;Message Signature or MAC validation section of JSON Web Signature&lt;/a&gt;.
     * &lt;p&gt;
     * Note that &quot;jku&quot;, &quot;jwk&quot;, &quot;x5u&quot; and &quot;x5c&quot; should nor will &lt;b&gt;never&lt;/b&gt; be
     * implemented. It does not make sense for the serialization to contain its
     * own validation.
     *
     * @param serialization
     *            JWS compact serialization
     * @param keyset
     *            JSON web key used to validate the token
     * @return the JWS payload
     * @throws GeneralSecurityException
     *             problem with crypto APIs or signature was not valid
     */
    public static byte[] getJwsPayload(final String serialization,
            final JsonWebKeySet keyset) throws GeneralSecurityException {
<span class="nc" id="L43">        final String[] jwtParts = serialization.split(&quot;\\.&quot;);</span>

<span class="nc" id="L45">        final JsonObject joseHeader = Json.createReader(</span>
                new ByteArrayInputStream(Base64.decode(jwtParts[0])))
                .readObject();

        // Handle plaintext JWTs
<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (!&quot;none&quot;.equals(joseHeader.getString(&quot;alg&quot;))) {</span>

            final String kid;
<span class="nc bnc" id="L53" title="All 2 branches missed.">            if (joseHeader.containsKey(&quot;kid&quot;)) {</span>
<span class="nc" id="L54">                kid = joseHeader.getString(&quot;kid&quot;);</span>
            } else {
<span class="nc" id="L56">                kid = &quot;&quot;;</span>
            }
<span class="nc" id="L58">            final PublicKey signingKey = keyset.getKey(kid, PublicKey.class);</span>

<span class="nc bnc" id="L60" title="All 2 branches missed.">            if (signingKey == null) {</span>
<span class="nc" id="L61">                throw new GeneralSecurityException(&quot;No key with id &quot; + kid</span>
                        + &quot; defined&quot;);
            }

<span class="nc" id="L65">            final Signature signature = Signature</span>
                    .getInstance(toJavaAlgorithm(joseHeader.getString(&quot;alg&quot;)));

<span class="nc" id="L68">            final byte[] jwtSignatureBytes = Base64.decode(jwtParts[2]);</span>

<span class="nc" id="L70">            signature.initVerify(signingKey);</span>
<span class="nc" id="L71">            signature.update((jwtParts[0] + &quot;.&quot; + jwtParts[1]).getBytes());</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">            if (!signature.verify(jwtSignatureBytes)) {</span>
<span class="nc" id="L73">                throw new GeneralSecurityException(</span>
                        &quot;signature verification failed&quot;);
            }
        }
<span class="nc" id="L77">        return Base64.decode(jwtParts[1]);</span>
    }

    /**
     * Checks if the request uses the GET method.
     *
     * @param req
     *            request
     * @return &lt;code&gt;true&lt;/code&gt; if the request uses the GET method.
     */
    public static boolean isGetRequest(final HttpServletRequest req) {
<span class="nc" id="L88">        return &quot;GET&quot;.equals(req.getMethod());</span>
    }

    /**
     * Checks if the request uses the HEAD method.
     *
     * @param req
     *            request
     * @return &lt;code&gt;true&lt;/code&gt; if the request uses the HEAD method.
     */
    public static boolean isHeadRequest(final HttpServletRequest req) {
<span class="nc" id="L99">        return &quot;HEAD&quot;.equals(req.getMethod());</span>
    }

    /**
     * Checks if the request is idempotent (i.e. &quot;GET&quot; or &quot;HEAD&quot; method).
     *
     * @param req
     *            request
     * @return &lt;code&gt;true&lt;/code&gt; if the request uses the GET or HEAD method.
     */
    public static boolean isIdempotentRequest(final HttpServletRequest req) {
<span class="nc bnc" id="L110" title="All 4 branches missed.">        return isGetRequest(req) || isHeadRequest(req);</span>
    }

    /**
     * Checks if string is null or empty.
     *
     * @param s
     *            string to test
     * @return true if string is null or empty.
     */
    public static boolean isNullOrEmpty(final String s) {
<span class="pc bpc" id="L121" title="1 of 4 branches missed.">        return s == null || s.trim().length() == 0;</span>
    }

    /**
     * Maps &lt;a href=
     * &quot;http://tools.ietf.org/html/draft-ietf-jose-json-web-algorithms-29&quot;&gt;JSON
     * Web Algorithm&lt;/a&gt; names to &lt;a href=
     * &quot;http://docs.oracle.com/javase/7/docs/technotes/guides/security/SunProviders.html&quot;
     * &gt;Java Crypto&lt;/a&gt; names. If the mapping is not known then the original
     * value is returned.
     *
     * @param alg
     *            algorithm name
     * @return algorithm name
     */
    public static String toJavaAlgorithm(final String alg) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (&quot;RS256&quot;.equalsIgnoreCase(alg)) {</span>
<span class="nc" id="L138">            return &quot;SHA256withRSA&quot;;</span>
        }
<span class="nc" id="L140">        return alg;</span>
    }

    /**
     * Validates the ID Token.
     *
     * @param clientId
     *            client ID
     * @param idTokenJson
     *            ID Token JSON.
     * @throws GeneralSecurityException
     */
    public static void validateIdToken(final String clientId,
            final JsonObject idTokenJson) throws GeneralSecurityException {
        // TODO handle multiple audiences
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (!clientId.equals(idTokenJson.getString(&quot;aud&quot;))) {</span>
<span class="nc" id="L156">            throw new GeneralSecurityException(String.format(</span>
                    &quot;invalid 'aud' got' %s' expected '%s'&quot;,
                    idTokenJson.getString(&quot;aud&quot;), clientId));
        }
<span class="nc bnc" id="L160" title="All 4 branches missed.">        if (idTokenJson.containsKey(&quot;azp&quot;)</span>
                &amp;&amp; !clientId.equals(idTokenJson.getString(&quot;azp&quot;))) {
<span class="nc" id="L162">            throw new GeneralSecurityException(String.format(</span>
                    &quot;invalid 'azp' got' %s' expected '%s'&quot;,
                    idTokenJson.getString(&quot;azp&quot;), clientId));
        }
<span class="nc bnc" id="L166" title="All 4 branches missed.">        if (idTokenJson.containsKey(&quot;exp&quot;)</span>
                &amp;&amp; System.currentTimeMillis() &gt; idTokenJson.getInt(&quot;exp&quot;) * 1000L) {
<span class="nc" id="L168">            throw new GeneralSecurityException(&quot;expired&quot;);</span>
        }
<span class="nc" id="L170">    }</span>

    /**
     * Prevent instantiation of utility class.
     */
<span class="fc" id="L175">    private Utils() {</span>
<span class="fc" id="L176">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>