<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Utils.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Server Auth Modules</a> &gt; <a href="index.source.html" class="el_package">net.trajano.auth.internal</a> &gt; <span class="el_source">Utils.java</span></div><h1>Utils.java</h1><pre class="source lang-java linenums">package net.trajano.auth.internal;

import java.io.ByteArrayInputStream;
import java.security.GeneralSecurityException;
import java.security.PublicKey;
import java.security.Signature;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.json.Json;
import javax.json.JsonObject;
import javax.servlet.http.HttpServletRequest;

/**
 * Utility methods. Normally these would be in a separate JAR file like
 * commons-lang, but to prevent complications during installation such as
 * requiring to install additional JAR files, this class was created.
 *
 * @author Archimedes Trajano
 */
public final class Utils {
    /**
     * Logger.
     */
    private static final Logger LOG;

    /**
     * Messages resource path.
     */
    private static final String MESSAGES = &quot;META-INF/Messages&quot;;

    static {
<span class="fc" id="L33">        LOG = Logger.getLogger(&quot;net.trajano.auth.oauthsam&quot;, MESSAGES);</span>
<span class="fc" id="L34">    }</span>

    /**
     * Gets the JWS Payload from a &lt;a href=
     * &quot;http://tools.ietf.org/html/draft-ietf-jose-json-web-signature-30#section-3.1&quot;
     * &gt;JWS Compact Serialization&lt;/a&gt;. The validation follows the rules in &lt;a
     * href=
     * &quot;http://tools.ietf.org/html/draft-ietf-jose-json-web-signature-30#section-5.2&quot;
     * &gt;Message Signature or MAC validation section of JSON Web Signature&lt;/a&gt;.
     * &lt;p&gt;
     * Note that &quot;jku&quot;, &quot;jwk&quot;, &quot;x5u&quot; and &quot;x5c&quot; should nor will &lt;b&gt;never&lt;/b&gt; be
     * implemented. It does not make sense for the serialization to contain its
     * own validation.
     *
     * @param serialization
     *            JWS compact serialization
     * @param keyset
     *            JSON web key used to validate the token
     * @return the JWS payload
     * @throws GeneralSecurityException
     *             problem with crypto APIs or signature was not valid
     */
    public static byte[] getJwsPayload(final String serialization, final JsonWebKeySet keyset) throws GeneralSecurityException {
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        if (LOG.isLoggable(Level.FINEST)) {</span>
<span class="nc" id="L58">            LOG.finest(&quot;serialized payload = &quot; + serialization);</span>
        }
<span class="fc" id="L60">        final String[] jwtParts = serialization.split(&quot;\\.&quot;);</span>

<span class="fc" id="L62">        final JsonObject joseHeader = Json.createReader(new ByteArrayInputStream(Base64.decode(jwtParts[0])))</span>
                .readObject();

        // Handle plaintext JWTs
<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (!&quot;none&quot;.equals(joseHeader.getString(&quot;alg&quot;))) {</span>

            final String kid;
<span class="fc bfc" id="L69" title="All 2 branches covered.">            if (joseHeader.containsKey(&quot;kid&quot;)) {</span>
<span class="fc" id="L70">                kid = joseHeader.getString(&quot;kid&quot;);</span>
            } else {
<span class="fc" id="L72">                kid = &quot;&quot;;</span>
            }
<span class="fc" id="L74">            final PublicKey signingKey = keyset.getKey(kid, PublicKey.class);</span>

<span class="pc bpc" id="L76" title="1 of 2 branches missed.">            if (signingKey == null) {</span>
<span class="nc" id="L77">                throw new GeneralSecurityException(&quot;No key with id &quot; + kid + &quot; defined&quot;);</span>
            }

<span class="fc" id="L80">            final Signature signature = Signature.getInstance(toJavaAlgorithm(joseHeader.getString(&quot;alg&quot;)));</span>

<span class="fc" id="L82">            final byte[] jwtSignatureBytes = Base64.decode(jwtParts[2]);</span>

<span class="fc" id="L84">            signature.initVerify(signingKey);</span>
<span class="fc" id="L85">            signature.update((jwtParts[0] + &quot;.&quot; + jwtParts[1]).getBytes());</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">            if (!signature.verify(jwtSignatureBytes)) {</span>
<span class="nc" id="L87">                throw new GeneralSecurityException(&quot;signature verification failed&quot;);</span>
            }
        }
<span class="fc" id="L90">        return Base64.decode(jwtParts[1]);</span>
    }

    /**
     * Checks if the request uses the GET method.
     *
     * @param req
     *            request
     * @return &lt;code&gt;true&lt;/code&gt; if the request uses the GET method.
     */
    public static boolean isGetRequest(final HttpServletRequest req) {
<span class="fc" id="L101">        return &quot;GET&quot;.equals(req.getMethod());</span>
    }

    /**
     * Checks if the request uses the HEAD method.
     *
     * @param req
     *            request
     * @return &lt;code&gt;true&lt;/code&gt; if the request uses the HEAD method.
     */
    public static boolean isHeadRequest(final HttpServletRequest req) {
<span class="fc" id="L112">        return &quot;HEAD&quot;.equals(req.getMethod());</span>
    }

    /**
     * Checks if string is null or empty.
     *
     * @param s
     *            string to test
     * @return true if string is null or empty.
     */
    public static boolean isNullOrEmpty(final String s) {
<span class="fc bfc" id="L123" title="All 4 branches covered.">        return s == null || s.trim()</span>
                .length() == 0;
    }

    /**
     * Checks if the request is to retrieve data (i.e. &quot;GET&quot; or &quot;HEAD&quot; method).
     *
     * @param req
     *            request
     * @return &lt;code&gt;true&lt;/code&gt; if the request uses the GET or HEAD method.
     */
    public static boolean isRetrievalRequest(final HttpServletRequest req) {
<span class="fc bfc" id="L135" title="All 4 branches covered.">        return isGetRequest(req) || isHeadRequest(req);</span>
    }

    /**
     * Maps &lt;a href=
     * &quot;http://tools.ietf.org/html/draft-ietf-jose-json-web-algorithms-29&quot;&gt;JSON
     * Web Algorithm&lt;/a&gt; names to &lt;a href=
     * &quot;http://docs.oracle.com/javase/7/docs/technotes/guides/security/SunProviders.html&quot;
     * &gt;Java Crypto&lt;/a&gt; names. If the mapping is not known then the original
     * value is returned.
     *
     * @param alg
     *            algorithm name
     * @return algorithm name
     */
    public static String toJavaAlgorithm(final String alg) {
<span class="fc" id="L151">        return JsonWebAlgorithm.valueOf(alg)</span>
                .toJca();
    }

    /**
     * Validates the ID Token.
     *
     * @param clientId
     *            client ID
     * @param idTokenJson
     *            ID Token JSON.
     * @throws GeneralSecurityException
     */
    public static void validateIdToken(final String clientId, final JsonObject idTokenJson) throws GeneralSecurityException {
        // TODO handle multiple audiences
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">        if (!clientId.equals(idTokenJson.getString(&quot;aud&quot;))) {</span>
<span class="nc" id="L167">            throw new GeneralSecurityException(String.format(&quot;invalid 'aud' got' %s' expected '%s'&quot;, idTokenJson.getString(&quot;aud&quot;), clientId));</span>
        }
<span class="pc bpc" id="L169" title="1 of 4 branches missed.">        if (idTokenJson.containsKey(&quot;azp&quot;) &amp;&amp; !clientId.equals(idTokenJson.getString(&quot;azp&quot;))) {</span>
<span class="nc" id="L170">            throw new GeneralSecurityException(String.format(&quot;invalid 'azp' got' %s' expected '%s'&quot;, idTokenJson.getString(&quot;azp&quot;), clientId));</span>
        }
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">        if (idTokenJson.containsKey(&quot;exp&quot;)) {</span>
<span class="fc" id="L173">            final long delta = System.currentTimeMillis() - idTokenJson.getInt(&quot;exp&quot;) * 1000L;</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">            if (delta &gt;= 0) {</span>
<span class="nc" id="L175">                throw new GeneralSecurityException(&quot;expired &quot; + delta + &quot;ms ago&quot;);</span>
            }
        }
<span class="fc" id="L178">    }</span>

    /**
     * Prevent instantiation of utility class.
     */
<span class="fc" id="L183">    private Utils() {</span>
<span class="fc" id="L184">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>